<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplayer Shooter</title>
<style>
/* CSS รวมสำหรับ UI, joystick, responsive */
* {
  box-sizing: border-box;
  margin: 0; padding: 0;
}
html, body {
  height: 100%;
  font-family: Arial, Helvetica, sans-serif;
  background: #121212;
  color: #fff;
  -webkit-touch-callout:none; /* ป้องกันคัดลอกบนมือถือ */
  -webkit-user-select:none;
  user-select:none;
  overflow: hidden;
}
.screen {
  display: none;
  height: 100vh;
  width: 100vw;
  align-items: center;
  justify-content: center;
}
.screen.active {
  display: flex;
}
.card {
  background: rgba(255,255,255,0.95);
  color: #222;
  padding: 18px;
  border-radius: 10px;
  width: 360px;
  max-width: 94%;
}
input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #ddd;
  font-size: 15px;
}
button {
  width: 100%;
  padding: 12px;
  border-radius: 6px;
  border: none;
  background: #4caf50;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
}
button.secondary {
  background: #2196f3;
  margin-top: 8px;
}
.msg {
  margin-top: 8px;
  color: #e53935;
  min-height: 18px;
}
#gameCanvas {
  display: block;
  margin: 6vh auto 0;
  border: 3px solid #4caf50;
  border-radius: 8px;
  background: #222;
  touch-action: none;
}
#chatContainer {
  position: fixed;
  left: 12px;
  top: 12px;
  width: 320px;
  max-width: 90vw;
  background: rgba(0,0,0,0.7);
  padding: 8px;
  border-radius: 8px;
  font-size: 14px;
  user-select: text;
  z-index: 9999; /* ให้อยู่ด้านบน */
  box-sizing: border-box;
  max-height: 60vh; /* กำหนดสูงสุดไม่ให้ล้นจอ */
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
#chatMessages {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
  border-bottom: 1px solid #4caf50;
  word-wrap: break-word;
}
#chatInputContainer {
  display: flex;
  margin-top: 8px;
}
#chatInput {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  background: #121212;
  color: #fff;
  font-size: 14px;
  outline: none;
}
#chatSend {
  padding: 8px 12px;
  background: #4caf50;
  border: none;
  color: #fff;
  border-radius: 6px;
  margin-left: 6px;
  cursor: pointer;
  user-select: none;
}
#chatSend:disabled {
  background: #666;
  cursor: default;
}
#chatToggle {
  position: fixed;
  left: calc(12px + 320px + 12px); /* ติดข้างขวากล่องแชท */
  top: 12px;
  background: #4caf50;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  color: #121212;
  cursor: pointer;
  user-select: none;
  z-index: 10000;
  box-sizing: border-box;
}
.joystick {
  position: fixed;
  left: 14px;
  bottom: 14px;
  width: 110px;
  height: 110px;
  border-radius: 50%;
  background: rgba(255,255,255,0.04);
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: none;
  z-index: 50;
}
.joystick .pad {
  position: relative;
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: rgba(255,255,255,0.06);
  display: flex;
  align-items: center;
  justify-content: center;
}
.joystick .knob {
  position: absolute;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: rgba(255,255,255,0.12);
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  touch-action: none;
}
.shoot-btn {
  position: fixed;
  right: 24px;
  bottom: 24px;
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: #e53935;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  z-index: 50;
  color: white;
  user-select: none;
  cursor: pointer;
}

</style>
</head>
<body>

<!-- Login -->
<div id="loginScreen" class="screen active">
  <div class="card">
    <h1>Login / Create Room</h1>
    <input id="loginUsername" placeholder="ชื่อผู้เล่น" maxlength="15" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="loginRoom" placeholder="ชื่อห้อง" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="loginRoomCode" placeholder="รหัสห้อง 4 หลัก" maxlength="4" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <button id="loginBtn">Login to Room</button>
    <div style="text-align:center;margin:10px 0;color:#666;font-weight:bold">OR</div>
    <input id="createRoomName" placeholder="สร้างห้อง: ชื่อห้อง" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="createRoomCode" placeholder="รหัสห้อง 4 หลัก" maxlength="4" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <button id="createRoomBtn" class="secondary">Create Room</button>
    <div id="loginError" class="msg"></div>
  </div>
</div>

<!-- Lobby -->
<div id="lobbyScreen" class="screen">
  <div class="card" style="background:transparent;color:#fff;text-align:center">
    <h2>Welcome, <span id="lobbyUsername"></span></h2>
    <h3>Room: <span id="lobbyRoom"></span> (Code: <span id="lobbyRoomCode"></span>)</h3>
    <button id="startGameBtn">Start Game</button>
  </div>
</div>

<!-- Gameplay -->
<div id="gameplayScreen" class="screen">
  <button id="chatToggle">Hide Chat</button>
  <div id="chatContainer">
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" placeholder="พิมพ์ข้อความ..." disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <button id="chatSend" disabled>ส่ง</button>
    </div>
  </div>

  <div class="joystick" id="joystick">
    <div class="pad"><div class="knob" id="knob"></div></div>
  </div>
  <div class="shoot-btn" id="shootBtn">F</div>

  <canvas id="gameCanvas"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

/* --- UI References --- */
const loginScreen = document.getElementById('loginScreen');
const lobbyScreen = document.getElementById('lobbyScreen');
const gameplayScreen = document.getElementById('gameplayScreen');

const loginUsername = document.getElementById('loginUsername');
const loginRoom = document.getElementById('loginRoom');
const loginRoomCode = document.getElementById('loginRoomCode');
const loginBtn = document.getElementById('loginBtn');

const createRoomName = document.getElementById('createRoomName');
const createRoomCode = document.getElementById('createRoomCode');
const createRoomBtn = document.getElementById('createRoomBtn');

const loginError = document.getElementById('loginError');
const lobbyUsername = document.getElementById('lobbyUsername');
const lobbyRoom = document.getElementById('lobbyRoom');
const lobbyRoomCode = document.getElementById('lobbyRoomCode');
const startGameBtn = document.getElementById('startGameBtn');

const chatToggle = document.getElementById('chatToggle');
const chatContainer = document.getElementById('chatContainer');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.querySelector('#chatInput');
const chatSend = document.querySelector('#chatSend');

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const joystick = document.getElementById('joystick');
const knob = document.getElementById('knob');
const shootBtn = document.getElementById('shootBtn');

/* --- State variables --- */
let username = '', roomName = '', roomCode = '';
let players = {}, bullets = [], myId = null;
let started = false;

/* Local player state */
let local = { x: 400, y: 300, angle: 0, isShooting: false, hp: 100 };

/* Input tracking */
let keys = {};
let joystickActive = false, joyCenter = {x:0,y:0}, joyId = null;

/* --- Helpers --- */
function resizeCanvas() {
  if(window.innerWidth <= 768) {
    canvas.width = window.innerWidth;
    canvas.height = Math.floor(window.innerHeight * 0.72);
  } else {
    canvas.width = 800;
    canvas.height = 600;
  }
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function showScreen(screen) {
  loginScreen.classList.remove('active');
  lobbyScreen.classList.remove('active');
  gameplayScreen.classList.remove('active');
  screen.classList.add('active');
}

function isValidCode(code) {
  return /^\d{4}$/.test(String(code));
}

function clampLocal() {
  local.x = Math.max(0, Math.min(canvas.width, local.x));
  local.y = Math.max(0, Math.min(canvas.height, local.y));
}

/* --- Create Room --- */
createRoomBtn.addEventListener('click', async () => {
  loginError.style.color = 'red';
  loginError.textContent = '';
  const rn = createRoomName.value.trim();
  const rc = createRoomCode.value.trim();

  if(!rn){
    loginError.textContent = 'กรุณากรอกชื่อห้อง';
    return;
  }
  if(!isValidCode(rc)){
    loginError.textContent = 'รหัสห้องต้อง 4 หลัก';
    return;
  }

  try {
    const r = await fetch('/createRoom', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({roomName: rn, roomCode: String(rc)})
    });
    const j = await r.json();
    if(j.success){
      loginError.style.color = 'green';
      loginError.textContent = 'สร้างห้องสำเร็จ';
    } else {
      loginError.style.color = 'red';
      loginError.textContent = j.error || 'สร้างห้องล้มเหลว';
    }
  } catch(e){
    loginError.style.color = 'red';
    loginError.textContent = 'เชื่อมต่อไม่สำเร็จ';
  }
});

/* --- Login to Room --- */
loginBtn.addEventListener('click', async () => {
  loginError.style.color = 'red';
  loginError.textContent = '';
  const un = loginUsername.value.trim();
  const rn = loginRoom.value.trim();
  const rc = loginRoomCode.value.trim();

  if(un.length < 3){
    loginError.textContent = 'ชื่อผู้เล่นอย่างน้อย 3 ตัว';
    return;
  }
  if(!rn){
    loginError.textContent = 'กรุณากรอกชื่อห้อง';
    return;
  }
  if(!isValidCode(rc)){
    loginError.textContent = 'รหัสห้องต้อง 4 หลัก';
    return;
  }

  try {
    const r = await fetch('/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username: un, roomName: rn, roomCode: String(rc)})
    });
    const j = await r.json();
    if(j.success){
      username = un;
      roomName = rn;
      roomCode = String(rc);
      lobbyUsername.textContent = username;
      lobbyRoom.textContent = roomName;
      lobbyRoomCode.textContent = roomCode;
      showScreen(lobbyScreen);
    } else {
      loginError.textContent = j.error || 'ล็อกอินล้มเหลว';
    }
  } catch(e){
    loginError.textContent = 'เชื่อมต่อไม่สำเร็จ';
  }
});

/* --- Start Game & Join Room --- */
startGameBtn.addEventListener('click', () => {
  if(!username || !roomName || !roomCode) return;
  socket.emit('joinRoom', {username, roomName, roomCode});
  showScreen(gameplayScreen);
  startGame();
});

/* --- Chat handlers --- */
chatSend.addEventListener('click', () => {
  if(chatInput.disabled) return;
  const msg = chatInput.value.trim();
  if(msg === '') return;
  socket.emit('chat message', msg);
  chatInput.value = '';
});

chatInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') chatSend.click();
});

chatToggle.addEventListener('click', () => {
  if(chatContainer.style.display === 'none'){
    chatContainer.style.display = 'block';
    chatToggle.textContent = 'Hide Chat';
  } else {
    chatContainer.style.display = 'none';
    chatToggle.textContent = 'Show Chat';
  }
});

/* --- Socket event handlers --- */
socket.on('errorMsg', msg => {
  if(!started){
    loginError.style.color = 'red';
    loginError.textContent = msg;
    showScreen(loginScreen);
  } else {
    alert(msg);
  }
});

socket.on('registered', id => {
  myId = id;
  console.log('registered', id);
  chatInput.disabled = false;
  chatSend.disabled = false;
});

socket.on('playersUpdate', data => {
  players = data || {};
});

socket.on('gameState', state => {
  if(state){
    players = state.players || players;
    bullets = state.bullets || bullets;
  }
});

socket.on('chat message', ({username: from, message}) => {
  const d = document.createElement('div');
  d.textContent = `${from}: ${message}`;
  chatMessages.appendChild(d);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

socket.on('dead', () => {
  alert('คุณตาย รอสปอร์นอัตโนมัติ...');
  // รอสปอร์น 3 วินาทีอัตโนมัติ
  setTimeout(() => {
    socket.emit('respawnRequest');
  }, 1);
});

socket.on('respawn', ({x, y, hp}) => {
  if(myId && players[myId]){
    players[myId].x = x;
    players[myId].y = y;
    players[myId].hp = hp;
    players[myId].dead = false;
  }
});

/* --- Keyboard input --- */
window.addEventListener('keydown', e => {
  keys[e.key.toLowerCase()] = true;
  if(e.key === ' ') local.isShooting = true;
});

window.addEventListener('keyup', e => {
  keys[e.key.toLowerCase()] = false;
  if(e.key === ' ') local.isShooting = false;
});

/* --- Mouse move aiming --- */
canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  local.angle = Math.atan2(my - local.y, mx - local.x);
});

/* --- Joystick touch control --- */
function centerOf(el) {
  const r = el.getBoundingClientRect();
  return { x: r.left + r.width/2, y: r.top + r.height/2 };
}
joystick.addEventListener('touchstart', e => {
  e.preventDefault();
  if(joystickActive) return;
  const t = e.changedTouches[0];
  joystickActive = true;
  joyId = t.identifier;
  joyCenter = centerOf(joystick);
  knob.style.left = '50%';
  knob.style.top = '50%';
  knob.style.transform = 'translate(0px, 0px)';
});
joystick.addEventListener('touchmove', e => {
  e.preventDefault();
  if(!joystickActive) return;
  let touch = null;
  for(let i=0; i<e.touches.length; i++){
    if(e.touches[i].identifier === joyId) {
      touch = e.touches[i];
      break;
    }
  }
  if(!touch) return;
  const dx = touch.clientX - joyCenter.x;
  const dy = touch.clientY - joyCenter.y;
  const max = 36;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const nx = dist > max ? (dx / dist) * max : dx;
  const ny = dist > max ? (dy / dist) * max : dy;
  knob.style.transform = `translate(${nx}px, ${ny}px)`;
  local.x += (nx / max) * 3;
  local.y += (ny / max) * 3;
  clampLocal();
});
joystick.addEventListener('touchend', e => {
  e.preventDefault();
  for(let i=0; i<e.changedTouches.length; i++){
    if(e.changedTouches[i].identifier === joyId){
      joystickActive = false;
      joyId = null;
      knob.style.transform = 'translate(0px, 0px)';
      break;
    }
  }
});

/* --- Right side touch for aiming/shooting --- */
let rightId = null;
canvas.addEventListener('touchstart', e => {
  for(let i=0; i<e.touches.length; i++){
    const t = e.touches[i];
    if(t.clientX > window.innerWidth / 2){
      rightId = t.identifier;
      const r = canvas.getBoundingClientRect();
      local.angle = Math.atan2((t.clientY - r.top) - local.y, (t.clientX - r.left) - local.x);
    }
  }
}, {passive:false});

canvas.addEventListener('touchmove', e => {
  for(let i=0; i<e.touches.length; i++){
    const t = e.touches[i];
    if(t.identifier === rightId){
      const r = canvas.getBoundingClientRect();
      local.angle = Math.atan2((t.clientY - r.top) - local.y, (t.clientX - r.left) - local.x);
    }
  }
}, {passive:false});

canvas.addEventListener('touchend', e => {
  for(let i=0; i<e.changedTouches.length; i++){
    const t = e.changedTouches[i];
    if(t.identifier === rightId){
      rightId = null;
      local.isShooting = true;
    }
  }
}, {passive:false});

/* --- Shoot button touch --- */
shootBtn.addEventListener('touchstart', e => {
  e.preventDefault();
  local.isShooting = true;
}, {passive:false});

/* --- Main game loop --- */
function drawPlayer(p, isMe){
  ctx.save();
  ctx.translate(p.x, p.y);
  ctx.rotate(p.angle || 0);
  ctx.fillStyle = isMe ? '#4caf50' : '#2196f3';
  ctx.fillRect(-15, -10, 30, 20);
  ctx.fillStyle = '#333';
  ctx.fillRect(0, -5, 20, 10);
  ctx.restore();

  ctx.fillStyle = '#fff';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(p.username || 'Player', p.x, p.y - 20);

  // HP bar background
  const w = 40, h = 6;
  const hx = p.x - w/2;
  const hy = p.y - 10;
  ctx.fillStyle = '#555';
  ctx.fillRect(hx, hy, w, h);

  // HP bar foreground
  const percent = Math.max(0, Math.min(1, (p.hp || 0) / 100));
  ctx.fillStyle = `rgb(${Math.floor(255 * (1 - percent))}, ${Math.floor(255 * percent)}, 0)`;
  ctx.fillRect(hx, hy, w * percent, h);
}

function loop(){
  const speed = 4;
  if(keys['w'] || keys['arrowup']) local.y -= speed;
  if(keys['s'] || keys['arrowdown']) local.y += speed;
  if(keys['a'] || keys['arrowleft']) local.x -= speed;
  if(keys['d'] || keys['arrowright']) local.x += speed;
  clampLocal();

  // ส่งข้อมูลตำแหน่งและสถานะผู้เล่นไปเซิร์ฟเวอร์
  socket.emit('playerMove', {
    x: Math.round(local.x),
    y: Math.round(local.y),
    angle: local.angle || 0,
    isShooting: !!local.isShooting,
    username
  });

  local.isShooting = false;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // วาดผู้เล่นทั้งหมด
  for(const id in players){
    const p = players[id];
    if(!p) continue;
    drawPlayer(p, id === myId);
  }

  // วาดกระสุน
  ctx.fillStyle = '#fff';
  (bullets || []).forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
    ctx.fill();
  });

  requestAnimationFrame(loop);
}

/* --- เริ่มเกม --- */
function startGame(){
  if(started) return;
  started = true;
  local.x = canvas.width / 2;
  local.y = canvas.height / 2;
  requestAnimationFrame(loop);
}

/* --- ป้องกัน scroll บนมือถือเมื่อ touch joystick หรือ canvas --- */
document.body.addEventListener('touchmove', function(e){
  if(e.target === canvas || e.target === joystick || e.target === knob){
    e.preventDefault();
  }
}, {passive:false});
</script>
</body>
</html>
